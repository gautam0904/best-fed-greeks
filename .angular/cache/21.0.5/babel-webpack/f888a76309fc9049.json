{"ast":null,"code":"import { Router } from '@angular/router';\nimport { HttpService } from './common/http.service';\nimport { Observable, BehaviorSubject } from 'rxjs';\nimport { BFGPushNotificationService } from './bfg-push-notification.service';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"./common/http.service\";\nimport * as i2 from \"@angular/router\";\nimport * as i3 from \"./bfg-push-notification.service\";\nexport let BFGUserService = /*#__PURE__*/(() => {\n  class BFGUserService {\n    http;\n    router;\n    push;\n    // will have access_token and other user information. Might be best to make an interface/model out of thise\n    _user;\n    _checkedStorage = false;\n    _currentHouseId = 0;\n    _houses = [];\n    _houseLocations = [];\n    _appFunctions = {};\n    _userConfigLoaded = new BehaviorSubject(false);\n    _houseChanged = new BehaviorSubject(false);\n    _isFetchingConfig = false;\n    userConfigLoaded = this._userConfigLoaded.asObservable();\n    houseChanged = this._houseChanged.asObservable();\n    constructor(http, router, push) {\n      this.http = http;\n      this.router = router;\n      this.push = push;\n      // Clear any cached data on app start\n      this.clearCachedData();\n    }\n    clearCachedData() {\n      try {\n        // Clear any cached API responses\n        if ('caches' in window) {\n          caches.keys().then(cacheNames => {\n            cacheNames.forEach(cacheName => {\n              caches.delete(cacheName);\n            });\n          });\n        }\n        // Clear localStorage items that might contain old API URLs\n        const keysToKeep = ['user', 'push-notification-config'];\n        const allKeys = Object.keys(localStorage);\n        allKeys.forEach(key => {\n          if (!keysToKeep.includes(key)) {\n            localStorage.removeItem(key);\n          }\n        });\n      } catch (error) {\n        console.warn('Error clearing cached data:', error);\n      }\n    }\n    // Add missing methods that other parts of the app expect\n    get name() {\n      try {\n        return this._user ? this._user.name : '';\n      } catch (error) {\n        console.error('Error getting user name:', error);\n        return '';\n      }\n    }\n    set name(value) {\n      try {\n        if (this._user) {\n          this._user.name = value;\n          localStorage.setItem('user', JSON.stringify(this._user));\n        }\n      } catch (error) {\n        console.error('Error setting user name:', error);\n      }\n    }\n    get refreshToken() {\n      try {\n        return this._user ? this._user.refresh_token : '';\n      } catch (error) {\n        console.error('Error getting refresh token:', error);\n        return '';\n      }\n    }\n    getId() {\n      try {\n        return this._user ? this._user.id : '';\n      } catch (error) {\n        console.error('Error getting user ID:', error);\n        return '';\n      }\n    }\n    initializeHouses() {\n      return new Observable(observer => {\n        try {\n          // This method is called by other components to initialize houses\n          // The houses are already loaded in fetchUserConfig, so this is just a no-op\n          console.log('Houses initialization requested');\n          observer.next({});\n          observer.complete();\n        } catch (error) {\n          console.error('Error initializing houses:', error);\n          observer.error(error);\n        }\n      });\n    }\n    register(userData) {\n      return new Observable(observer => {\n        try {\n          this.http.post('bfg/auth/register', userData).subscribe(response => {\n            try {\n              observer.next(response);\n              observer.complete();\n            } catch (error) {\n              console.error('Error processing register response:', error);\n              observer.error(error);\n            }\n          }, error => {\n            console.error('Register error:', error);\n            observer.error(error);\n          });\n        } catch (error) {\n          console.error('Error in register method:', error);\n          observer.error(error);\n        }\n      });\n    }\n    fetchUser() {\n      return new Observable(observer => {\n        try {\n          observer.next(this.getOrRestoreUser());\n          observer.complete();\n        } catch (error) {\n          console.error('Error fetching user:', error);\n          observer.error(error);\n        }\n        return () => {};\n      });\n    }\n    get user() {\n      try {\n        return this.getOrRestoreUser();\n      } catch (error) {\n        console.error('Error getting user:', error);\n        return null;\n      }\n    }\n    loginMockUser() {\n      try {\n        this._user = {\n          name: 'Test User',\n          house: 'Delta Tau Delta',\n          access_token: 'not_a_secret'\n        };\n        localStorage.setItem('user', JSON.stringify(this._user));\n      } catch (error) {\n        console.error('Error setting mock user:', error);\n      }\n    }\n    setTokenFromResponse(token) {\n      try {\n        if (this._user) {\n          this._user.access_token = token;\n          localStorage.setItem('user', JSON.stringify(this._user));\n        }\n      } catch (error) {\n        console.error('Error setting token:', error);\n      }\n    }\n    clearStoredUser() {\n      try {\n        if (this.push && typeof this.push.clear === 'function') {\n          this.push.clear();\n        }\n        this._user = undefined;\n        localStorage.removeItem('user');\n      } catch (error) {\n        console.error('Error clearing stored user:', error);\n      }\n    }\n    isAuthenticated() {\n      try {\n        let user = this._user;\n        if (!this._checkedStorage) {\n          user = this.getOrRestoreUser();\n          this._checkedStorage = true;\n        }\n        return !!user;\n      } catch (error) {\n        console.error('Error checking authentication:', error);\n        return false;\n      }\n    }\n    getOrRestoreUser() {\n      try {\n        if (!this._user && localStorage.getItem('user')) {\n          this._user = JSON.parse(localStorage.getItem('user'));\n        }\n        if (!this._userConfigLoaded.value && !this._isFetchingConfig) {\n          this._isFetchingConfig = true;\n          this.fetchUserConfig().subscribe(() => {});\n        }\n        return this._user;\n      } catch (error) {\n        console.error('Error getting or restoring user:', error);\n        return null;\n      }\n    }\n    appFunctionEnabled(func) {\n      try {\n        return !!this._appFunctions[func];\n      } catch (error) {\n        console.error('Error checking app function:', error);\n        return false;\n      }\n    }\n    switchToHouse(houseId) {\n      try {\n        if (this.isStudent()) return;\n        this._currentHouseId = houseId;\n        let myHouse = null;\n        for (let house of this.houses) {\n          if (house.id == this._currentHouseId) {\n            myHouse = house;\n            break;\n          }\n        }\n        // @todo set these from the houses config\n      } catch (error) {\n        console.error('Error switching house:', error);\n      }\n    }\n    get houses() {\n      try {\n        return this._houses;\n      } catch (error) {\n        console.error('Error getting houses:', error);\n        return [];\n      }\n    }\n    get currentHouseId() {\n      try {\n        return this._currentHouseId;\n      } catch (error) {\n        console.error('Error getting current house ID:', error);\n        return 0;\n      }\n    }\n    get houseLocations() {\n      try {\n        return this._houseLocations;\n      } catch (error) {\n        console.error('Error getting house locations:', error);\n        return [];\n      }\n    }\n    isStudent() {\n      try {\n        return this._user && this._user.user_type === 'student';\n      } catch (error) {\n        console.error('Error checking if user is student:', error);\n        return false;\n      }\n    }\n    isChef() {\n      try {\n        return this._user && this._user.user_type === 'chef';\n      } catch (error) {\n        console.error('Error checking if user is chef:', error);\n        return false;\n      }\n    }\n    isSuperChef() {\n      try {\n        return this._user && this._user.user_type === 'super_chef';\n      } catch (error) {\n        console.error('Error checking if user is super chef:', error);\n        return false;\n      }\n    }\n    login(username, password) {\n      return new Observable(observer => {\n        try {\n          // Force clear any cached data before login\n          this.clearCachedData();\n          this.http.post('auth/login', {\n            login: username,\n            password\n          }).subscribe(response => {\n            try {\n              if (!response.error) {\n                this._user = response.user;\n                localStorage.setItem('user', JSON.stringify(this._user));\n                this._checkedStorage = true;\n              }\n              observer.next(response);\n              observer.complete();\n            } catch (error) {\n              console.error('Error processing login response:', error);\n              observer.error(error);\n            }\n          }, error => {\n            console.error('Login error:', error);\n            observer.error(error);\n          });\n        } catch (error) {\n          console.error('Error in login method:', error);\n          observer.error(error);\n        }\n      });\n    }\n    fetchUserConfig() {\n      return new Observable(observer => {\n        try {\n          if (!this.isAuthenticated()) {\n            this._userConfigLoaded.next(true);\n            observer.next({});\n            observer.complete();\n            return;\n          }\n          this.http.post('bfg/user/config', {}).subscribe(response => {\n            try {\n              if (!response.error) {\n                this._houses = response.houses || [];\n                this._houseLocations = response.house_locations || [];\n                this._appFunctions = response.app_functions || {};\n                if (this._houses.length > 0 && !this._currentHouseId) {\n                  this._currentHouseId = this._houses[0].id;\n                }\n              }\n              this._userConfigLoaded.next(true);\n              observer.next(response);\n              observer.complete();\n            } catch (error) {\n              console.error('Error processing user config response:', error);\n              this._userConfigLoaded.next(true);\n              observer.error(error);\n            }\n          }, error => {\n            console.error('User config error:', error);\n            this._userConfigLoaded.next(true);\n            observer.error(error);\n          });\n        } catch (error) {\n          console.error('Error in fetchUserConfig method:', error);\n          this._userConfigLoaded.next(true);\n          observer.error(error);\n        }\n      });\n    }\n    logout() {\n      try {\n        this.clearStoredUser();\n        this.router.navigateByUrl('/login');\n      } catch (error) {\n        console.error('Error during logout:', error);\n      }\n    }\n    static ɵfac = function BFGUserService_Factory(__ngFactoryType__) {\n      return new (__ngFactoryType__ || BFGUserService)(i0.ɵɵinject(i1.HttpService), i0.ɵɵinject(i2.Router), i0.ɵɵinject(i3.BFGPushNotificationService));\n    };\n    static ɵprov = /*@__PURE__*/i0.ɵɵdefineInjectable({\n      token: BFGUserService,\n      factory: BFGUserService.ɵfac,\n      providedIn: 'root'\n    });\n  }\n  return BFGUserService;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}